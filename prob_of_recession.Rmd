---
title: "Probability of Recession"
author: "William Chiu"
date: "2022-11-13"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

```

## Summary

Forecast the probability of a recession in the next 6 months using the following predictors:

1.  Spread between 10Y CMT and Effective Federal Funds Rate
2.  YOY change in Unemployment Rate
3.  YOY growth in CPI-U

## Extract Historical Data

Refer to this [vignette](https://cran.r-project.org/web/packages/fredr/vignettes/fredr.html) for FRED data access.

```{r}
library(tidyverse)
library(lubridate)
library(caTools)
library(scam)
library(fredr)
library(effects)
library(car)
library(MLmetrics)

series_id <- c("FEDFUNDS", "GS10", "USREC", "UNRATE", "CPIAUCSL")

full_data <- map_dfr(series_id, function(x) {
  fredr(
    series_id = x,
    observation_start = as.Date("1950-01-01"),
    observation_end = as.Date("2022-12-01")
  )
})
```

## Pivot Wider

```{r}
full_data_wide_raw <- full_data %>% 
  arrange(date) %>% 
  select(date, series_id, value) %>% 
  pivot_wider(id_cols=date, names_from = series_id, values_from = value)
```

## Calculate Features/Predictors

```{r}
full_data_wide_features <- full_data_wide_raw %>% 
  mutate(SPRD_10YCMT_FEDFUNDS = GS10 - FEDFUNDS,
         D_UNRATE = UNRATE - lag(UNRATE, 12),
         G_CPIU = (CPIAUCSL / lag(CPIAUCSL, 12) - 1) * 100
         ) 
```

## Recession in next 6 months

```{r}
full_data_wide <- full_data_wide_features %>% 
  arrange(date) %>% 
  mutate(USREC_LEAD1 = lead(USREC, 1),
         USREC_LEAD2 = lead(USREC, 2),
         USREC_LEAD3 = lead(USREC, 3),
         USREC_LEAD4 = lead(USREC, 4),
         USREC_LEAD5 = lead(USREC, 5),
         USREC_LEAD6 = lead(USREC, 6),
         FUTREC = pmax(USREC_LEAD1, USREC_LEAD2, USREC_LEAD3,
                                 USREC_LEAD4, USREC_LEAD5, USREC_LEAD6)) %>% 
  drop_na() %>% 
  select(-USREC, -USREC_LEAD1, -USREC_LEAD2, -USREC_LEAD3,
         -USREC_LEAD4, -USREC_LEAD5, -USREC_LEAD6) 
```



## Split Train/Test

```{r}
set.seed(111)

train_id <- sample.split(full_data_wide$FUTREC, SplitRatio = 0.80)

train_data <- full_data_wide[train_id,]
test_data <- full_data_wide[!train_id,]

summary(train_data)
```

## Logistic Regression

```{r}
logit_mod <- glm(FUTREC ~ SPRD_10YCMT_FEDFUNDS +
                   D_UNRATE + 
                   G_CPIU, data=train_data, family=binomial)

summary(logit_mod)
```

## Effect Plot for Logistic Regression

```{r}
plot(predictorEffects(logit_mod, focal.levels=1000),
     main=NULL,
     axes = list(
       grid = TRUE,
       x = list(rug = FALSE),
       y = list(type = "response")
     ))
```


## Logit with Knots

```{r}
logit_mod_knot <- glm(FUTREC ~ SPRD_10YCMT_FEDFUNDS + 
                        pmax(0,SPRD_10YCMT_FEDFUNDS) +
                        D_UNRATE +
                        pmax(0, D_UNRATE) +
                        G_CPIU +
                        pmax(0, G_CPIU),
                      data=train_data, family=binomial)

summary(logit_mod_knot)
```


## Effect Plot for Knots

```{r}
plot(predictorEffects(logit_mod_knot, focal.levels=1000),
     main=NULL,
     axes = list(
       grid = TRUE,
       x = list(rug = FALSE),
       y = list(type = "response")
     ))
```


## Shape-Constrained GAM

```{r}
scam_mod <- scam(FUTREC ~ s(SPRD_10YCMT_FEDFUNDS, bs="mpd") +
                   D_UNRATE  +
                   G_CPIU,
                 data=train_data, family=binomial())

summary(scam_mod)

plot(scam_mod,pages=1,se=FALSE)

```




## Null Model

```{r}
null_mod <- glm(FUTREC ~ 1, data=train_data, family=binomial)

summary(null_mod)
```

## Performance Metrics

```{r}
test_preds <- predict(logit_mod, newdata=test_data, type="response")
null_preds <- predict(null_mod, newdata=test_data, type="response")
knot_preds <- predict(logit_mod_knot, newdata=test_data, type="response")
scam_preds <- predict(scam_mod, newdata=test_data, type="response")


perf <- function(lst_preds, f_metric=caTools::colAUC, metricname="ROC-AUC"){
  map_dfr(lst_preds, function(x){
  f_metric(x, test_data$FUTREC)
}) %>% 
  pivot_longer(everything(), names_to="model", values_to=metricname) %>% 
  knitr::kable()
}

myPreds <- list(logit_reg=test_preds, null_model=null_preds,
                knot_reg=knot_preds, scam_mod = scam_preds)

perf(myPreds, caTools::colAUC, "ROC-AUC")
perf(myPreds, MLmetrics::LogLoss, "LogLoss")
```

## Probability of Recession (Most Recent Month)

```{r}

curr_data <- tail(full_data_wide_features, 1) %>% 
  select(date, UNRATE, SPRD_10YCMT_FEDFUNDS, D_UNRATE, G_CPIU)

knitr::kable(curr_data)
```


```{r}

mods <- list(logistic_reg=logit_mod,
                              scam_mod=scam_mod,
                              knot_mod=logit_mod_knot,
                              baseline=null_mod)

score_fun <- function(mods, dat) {
  output <- map_dfc(.x = mods, .f = function(x) {
    predict(x, newdata = dat, type = "response")
  }) %>%
    pivot_longer(everything(), names_to = "model",
                 values_to = "prob_rec")
  
  output$prob_rec <- scales::percent(output$prob_rec)
  
  return(output)
}


knitr::kable(score_fun(mods, curr_data))
```

## Probability of Recession (What-if)

What if:

1. Inversion between 10Y CMT and federal funds rate of 2 bps
2. Unemployment Rate increases to 3.9%, which is still 0.3% below Nov 2021's unemployment rate
3. Inflation hits 7.30%

```{r}
curr_data_what_if <- curr_data

curr_data_what_if$SPRD_10YCMT_FEDFUNDS <- -0.02
curr_data_what_if$D_UNRATE <- -0.3
curr_data_what_if$G_CPIU <- 7.30
curr_data_what_if$UNRATE <- 3.9
curr_data_what_if$date <- "2022-11-01"

knitr::kable(curr_data_what_if)
```

```{r}
knitr::kable(score_fun(mods, curr_data_what_if))

```


